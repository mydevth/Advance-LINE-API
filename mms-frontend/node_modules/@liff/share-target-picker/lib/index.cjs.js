"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/consts"),i=require("@liff/util"),r=require("@liff/store"),o=require("@liff/is-in-client"),n=require("@liff/is-logged-in"),s=require("@liff/analytics"),a=require("@liff/is-sub-window"),l=require("@liff/get-line-version"),h=require("@liff/logger"),u=require("@liff/server-api"),c=require("@liff/get-os"),f=require("@liff/window-postmessage");var d=function(){function r(){this.payloadToShareTargetPicker=null,this.popupWindow=null,this.doesWaitForSubwindowResult=!1}return r.getInstance=function(){return r.instance?r.instance.reset():r.instance=new r,r.instance},r.prototype.init=function(t){return e.__awaiter(this,void 0,void 0,(function(){var i,r;return e.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,5,,6]),this.liffId=t.referrer.liffId,this.doesWaitForSubwindowResult=!(!t.options||!t.options.waitForSubwindowResult),this.allowPostMessageOrigin=this.initAllowPostMessageOrigin(),this.payloadToShareTargetPicker=this.buildPayloadToShareTargetPicker(t),window.AbortController&&(this.abortController=new window.AbortController),this.prepareAnotherWindow(),[4,this.initOtt()];case 1:return e.sent(),this.initListener(),this.openAnotherWindow(),this.doesWaitForSubwindowResult?[4,this.pollingShareResult()]:[3,3];case 2:return i=e.sent(),this.finalize(),[2,i];case 3:return[2];case 4:return[3,6];case 5:if(r=e.sent(),this.finalize(),"AbortError"!==r.name)throw r;return[3,6];case 6:return[2]}}))}))},r.prototype.resetAllVariables=function(){this.liffId="",this.allowPostMessageOrigin="",this.payloadToShareTargetPicker=null,this.ott="",this.popupWindow=null,this.timeoutIDForHealthCheck=null,this.abortController=null,this.internalError=null,this.doesWaitForSubwindowResult=!1},r.prototype.reset=function(){this.finalize(),this.resetAllVariables()},r.prototype.finalize=function(){var e,t;this.abortController&&this.abortController.abort(),o.isInClient()||(e=this.timeoutIDForHealthCheck,t=this.popupWindow,f.removeListen(window,"message.receivedHealthcheck"),e&&clearTimeout(e),t&&!t.closed&&t.close())},r.prototype.buildPayloadToShareTargetPicker=function(e){return{messages:e.messages,isMultiple:e.isMultiple,referrer:e.referrer}},r.prototype.initAllowPostMessageOrigin=function(e){return void 0===e&&(e=u.getEndPoint("shareTargetPicker")),i.getOriginOfUrl(e)},r.prototype.initOtt=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,i,r;return e.__generator(this,(function(e){switch(e.label){case 0:return this.abortController&&(t=this.abortController.signal),i=u.getEndPoint("shareTargetPickerOtt")+"/"+this.liffId+"/ott",r=this,[4,u.fetch(i,{method:"GET",signal:t}).then((function(e){return e.ott}))];case 1:return r.ott=e.sent(),[2]}}))}))},r.prototype.prepareAnotherWindow=function(){o.isInClient()||("ios"!==c.getOS()||i.isIpad()?this.popupWindow=window.open("","liffpopup","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):this.popupWindow=window.open())},r.prototype.openAnotherWindow=function(){if(o.isInClient()&&this.payloadToShareTargetPicker)e=this.liffId,r=this.ott,n=this.payloadToShareTargetPicker,s={liffId:e,ott:r,data:JSON.stringify(n),closeModals:!1},location.href="line://picker?"+i.qs.stringify(s);else{if(this.timeoutIDForHealthCheck=window.setTimeout(this.healthCheck.bind(this),1e3),!this.popupWindow)throw i.createLiffError(t.CREATE_SUBWINDOW_FAILED);!function(e,t,r){var o={liffId:t,ott:r};e.location.href=u.getEndPoint("shareTargetPicker")+"?"+i.qs.stringify(o)}(this.popupWindow,this.liffId,this.ott)}var e,r,n,s},r.prototype.initListener=function(){var e,t;o.isInClient()||(e=this.onReceivedHealthcheck.bind(this),t=this.allowPostMessageOrigin,f.messageReceive(window,"receivedHealthcheck",e,t))},r.prototype.healthCheck=function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:if(this.popupWindow&&!this.popupWindow.closed)return[3,7];if(!this.doesWaitForSubwindowResult)return[3,5];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.onCanceled()];case 2:return e.sent(),[3,4];case 3:return t=e.sent(),this.internalError=t,[3,4];case 4:return[3,6];case 5:this.finalize(),e.label=6;case 6:return[3,8];case 7:i=this.popupWindow,r=this.allowPostMessageOrigin,f.messageTell(i,"healthcheck",void 0,r),this.timeoutIDForHealthCheck=window.setTimeout(this.healthCheck.bind(this),1e3),e.label=8;case 8:return[2]}var i,r}))}))},r.prototype.onReceivedHealthcheck=function(){if(!this.popupWindow||!this.payloadToShareTargetPicker)throw i.createLiffError(t.CREATE_SUBWINDOW_FAILED);var e,r,o;e=this.popupWindow,r=this.payloadToShareTargetPicker,o=this.allowPostMessageOrigin,f.messageTell(e,"ready",r,o)},r.prototype.onCanceled=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,r;return e.__generator(this,(function(e){switch(e.label){case 0:if(o.isInClient()||!this.ott)throw new Error("need to call with ott in client");return this.abortController&&(t=this.abortController.signal),r={liffId:this.liffId,ott:this.ott},[4,u.fetch(u.getEndPoint("shareTargetPickerResult")+"?"+i.qs.stringify(r),{method:"POST",signal:t,headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},body:"result=CANCEL"})];case 1:return[2,"ok"===e.sent().status]}}))}))},r.prototype.getShareResult=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,r;return e.__generator(this,(function(e){if(!this.ott)throw new Error("need to call with ott in client");return this.abortController&&(t=this.abortController.signal),r={liffId:this.liffId,ott:this.ott},h.logger.debug("fetch: getShareResult"),[2,u.fetch(u.getEndPoint("shareTargetPickerResult")+"?"+i.qs.stringify(r),{method:"GET",headers:{Accept:"application/json"},signal:t})]}))}))},r.isPollingTimeOut=function(e,t){return(t-e)/6e4>=10},r.prototype.pollingShareResult=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,i;return e.__generator(this,(function(e){switch(e.label){case 0:t=Date.now(),e.label=1;case 1:if(r.isPollingTimeOut(t,Date.now()))return[3,4];if(this.internalError)throw this.internalError;return[4,this.getShareResult()];case 2:if((i=e.sent())&&i.result)switch(i.result){case"SUCCESS":return[2,{status:"success"}];case"CANCEL":return[2];case"FAILURE":default:throw new Error(i.resultDescription)}return[4,new Promise((function(e){setTimeout(e,500)}))];case 3:return e.sent(),[3,1];case 4:throw new Error("Timeout: not finished within 10min")}}))}))},r}(),p=function(){function h(){var h=this;this.name="shareTargetPicker",this.shareTargetPicker=function(a,u){return void 0===u&&(u={}),e.__awaiter(h,void 0,void 0,(function(){var h,c,f,p,w,g,b;return e.__generator(this,(function(e){switch(e.label){case 0:if(h=void 0===u.isMultiple||u.isMultiple,this.checkPermission(),!n.isLoggedIn())throw i.createLiffError(t.UNAUTHORIZED,"Need access_token for api call, Please login first");if(!a||!Array.isArray(a)||0===a.length)throw i.createLiffError(t.INVALID_ARGUMENT,"no proper argument");if(a.length>t.MAX_NUM_OF_SEND_MESSAGES)throw i.createLiffError(t.INVALID_ARGUMENT,"exceed the limit of num of messages");if(!(c=r.getConfig().liffId))throw i.createLiffError(t.INVALID_CONFIG);window.liff&&(f=window.liff).analytics&&s.sendShareTargetPicker(f.analytics),e.label=1;case 1:return e.trys.push([1,3,,4]),p=d.getInstance(),w=l.getLineVersion(),g={waitForSubwindowResult:!0},o.isInClient()&&w&&i.compareVersion(w,"10.11.0")<0&&(g.waitForSubwindowResult=!1),[4,p.init({messages:a,isMultiple:h,referrer:{liffId:c,url:location.origin},options:g})];case 2:return[2,e.sent()];case 3:throw(b=e.sent())instanceof i.LiffError?b:i.createLiffError(t.EXCEPTION_IN_SUBWINDOW,b.message);case 4:return[2]}}))}))},this.checkPermission=function(){if(a.isSubWindow())throw i.createLiffError(t.FORBIDDEN,"The operation is not allowed in the SubWindow");var e=((r.getContext()||{}).availability||{}).shareTargetPicker||{},n=e.permission,s=e.minVer;if(!n)throw o.isInClient()?i.createLiffError(t.FORBIDDEN,"Need LINE App "+s+" at least or consent on shareTargetPicker usage on LINE developer site"):i.createLiffError(t.FORBIDDEN,"Need consent on shareTargetPicker usage on LINE developer site")}}return h.prototype.install=function(){return this.shareTargetPicker},h}(),w=new p;exports.ShareTargetPickerModule=p,exports.module=w;
