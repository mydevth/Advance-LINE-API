"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@liff/consts"),t=require("@liff/util"),r=require("@liff/is-in-client"),n=require("@liff/is-api-available"),i=require("tslib"),o=require("@liff/logger"),s=require("@liff/get-os"),a=require("@liff/server-api"),u=require("@liff/store"),c=require("@liff/message-bus"),f=require("@liff/is-sub-window"),l=require("@liff/close-window");function d(e){var t=a.getEndPoint("subWindowGetOrigin");return a.fetch(t(e))}var _={};function S(e,t){e&&_[e]&&_[e].forEach((function(e){e(t)}))}var I,w,g,m,v,h=function(){function r(e){this.storage=e}return r.prototype.getItem=function(e){return this.storage.getItem(this.getKeyPrefix()+":"+e)},r.prototype.setItem=function(e,t){this.storage.setItem(this.getKeyPrefix()+":"+e,t)},r.prototype.removeItem=function(e){this.storage.removeItem(this.getKeyPrefix()+":"+e)},r.prototype.clear=function(){this.storage.clear()},r.prototype.getKeyPrefix=function(){return e.STORE_KEY+":"+this.getLiffId()},r.prototype.getLiffId=function(){var r=u.getConfig().liffId;if(!r)throw t.createLiffError(e.INVALID_CONFIG,"liffId is necessary for liff.init()");return r},r}(),p=new h(t.inMemoryStorage);function E(){var e=p.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function N(e){p.setItem("subWindowStatusUpdated",String(e))}function T(e){I=e}function O(){return I}function U(){return g}function W(){return m}function L(e){return void 0===e&&(e=c.WINDOW.MAIN),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return[4,(v=new c.MessageBus(e)).setup()];case 1:return t.sent(),[2,v]}}))}))}function b(){return v}var A=new h(window.sessionStorage);function D(){return A.getItem("mainWindowOrigin")}function C(r,n){return void 0===n&&(n={}),i.__awaiter(this,void 0,void 0,(function(){var s,a,c,f,l,_,S,I;return i.__generator(this,(function(i){switch(i.label){case 0:if(null==(s=b())?void 0:s.isReady())return[3,5];if(a=JSON.stringify(n),c=u.getConfig().liffId,f=D(),!window.opener||!f||!c)throw t.createLiffError(e.EXCEPTION_IN_SUBWINDOW);l=!1,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,d(c)];case 2:return _=i.sent(),l=_.subwindowCommonModule,[3,4];case 3:throw S=i.sent(),o.logger.debug(S),t.createLiffError(e.EXCEPTION_IN_SUBWINDOW);case 4:return I=l?f:location.origin,[2,new Promise((function(t){window.addEventListener("message",(function n(i){(function(t){if(t.data&&"string"==typeof t.data.type&&[e.SUB_WINDOW_STATUS.SUBMIT,e.SUB_WINDOW_STATUS.CANCEL].includes(t.data.type))return!0;return!1})(i)&&(window.removeEventListener("message",n),t({status:r,result:a}))})),window.opener.postMessage({status:r,result:a},I)}))];case 5:return s.send({eventName:r,data:n}),[4,new Promise((function(e){setTimeout(e,500)}))];case 6:return i.sent(),[2,{status:r,result:JSON.stringify(n)}]}}))}))}function B(t){var r,n=W();if(t.origin===n){var i=t.data;if(i){var s,a=i.status,u=i.result;try{s=JSON.parse(u||"{}")}catch(c){s={}}switch(a){case e.SUB_WINDOW_HEALTH_CHECK_MESSAGE:window.clearInterval(U()),R();break;case e.SUB_WINDOW_STATUS.CANCEL:case e.SUB_WINDOW_STATUS.SUBMIT:N(!0),window.clearInterval(U()),window.removeEventListener("message",B),S(a,s),null===(r=O())||void 0===r||r.postMessage({type:a},W());break;default:o.logger.debug("unexpected message")}}}}var y=function(t){return i.__awaiter(void 0,void 0,void 0,(function(){var r,n,o,s;return i.__generator(this,(function(i){if(E())return[2];switch(r=t.context,n=r.eventName,o=r.data,s=b(),n){case e.SUB_WINDOW_STATUS.INIT:M(!o.hasOpener);break;case e.SUB_WINDOW_STATUS.CANCEL:case e.SUB_WINDOW_STATUS.SUBMIT:N(!0),S(n,o),null==s||s.reply(t,{eventName:n});break;case e.SUB_WINDOW_STATUS.CLOSE:!1===E()&&(N(!0),S(e.SUB_WINDOW_STATUS.CLOSE,{})),R()}return[2]}))}))};function P(){window.clearInterval(w),window.clearInterval(U()),window.removeEventListener("message",B)}function M(e){if(void 0===e&&(e=!1),P(),N(!1),e){var t=O();t&&(t.close(),T(null))}}function R(){return i.__awaiter(this,void 0,void 0,(function(){var e;return i.__generator(this,(function(t){switch(t.label){case 0:return(e=b())?[4,e.teardown()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}function H(r){return i.__awaiter(this,void 0,void 0,(function(){var n,o,a,u,f,l,_,I,v,h;return i.__generator(this,(function(p){switch(p.label){case 0:return(n=t.extractLiffId(r.url))?(M(!0),[4,R()]):[2,Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"params.url must be liff url"))];case 1:return p.sent(),o=r.url,a=r.appData,(u=new URL(o)).searchParams.append(e.SUB_WINDOW_IDNTIFICATION_KEY,"true"),[4,L()];case 2:return f=p.sent(),u.searchParams.append(c.IDENTIFIER_KEY,f.identification.identifier),u.searchParams.append(c.CRYPTO_KEY,f.identification.cryptoKey),u.hostname=function(e){var t=i.__read(e.split(".")),r=t[0],n=t.slice(1);return i.__spread([r+"-ext"],n).join(".")}(u.hostname),l=u.toString(),T("ios"!==s.getOS()||t.isIpad()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),[4,d(n)];case 3:if(_=p.sent(),I=_.origin,v=_.subwindowCommonModule,!(h=O()))throw t.createLiffError(e.CREATE_SUBWINDOW_FAILED);return v?(function(e){m=e}(I),f.listen(y),f.setData("appData",a),window.addEventListener("message",B),h.location.href=l,U=function(t,r){var n=O(),i={type:e.SUB_WINDOW_HEALTH_CHECK_MESSAGE};return r&&(i.message=JSON.stringify(r)),window.setInterval((function(){null==n||n.postMessage(i,t)}),e.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}(I,a),g=U,function(e){w=e}(window.setInterval((function(){var t=O();t&&t.closed&&(P(),T(null),!1===E()&&(N(!0),S(e.SUB_WINDOW_STATUS.CLOSE,{})))}),e.SUB_WINDOW_MONITOR_CLOSE_INTERVAL)),[2]):(h.close(),[2])}var U}))}))}function x(r){return i.__awaiter(this,void 0,void 0,(function(){var n,o,s,u,c,f,l,d,_,S,I;return i.__generator(this,(function(i){switch(i.label){case 0:n=r.msit,o=r.mstChallenge,s=r.onSuccess,u=r.onError,c=r.reconnectCount,f=void 0===c?0:c,i.label=1;case 1:return i.trys.push([1,3,,6]),[4,a.requestWithoutErrorHandling(a.getEndPoint("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:n,mstChallenge:o})})];case 2:return l=i.sent(),[3,6];case 3:return i.sent(),[4,K()];case 4:return i.sent(),[4,G(x,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f+=1})];case 5:return i.sent(),[2];case 6:return l.status>=500?[4,K()]:[3,9];case 7:return i.sent(),[4,G(x,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f+=1})];case 8:return i.sent(),[3,20];case 9:return l.status>=400&&500>l.status?[4,j(l)]:[3,11];case 10:return(_=i.sent())?(d=_.errorDetail,u(t.createLiffError(e.INVALID_ARGUMENT,d))):u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),[3,20];case 11:return 200!==l.status?[3,19]:[4,j(l)];case 12:return(_=i.sent())?[3,13]:(u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),[3,18]);case 13:switch(S=_.status,I=_.result,S){case e.SUB_WINDOW_STATUS.ERROR:return[3,14];case e.SUB_WINDOW_STATUS.CLOSE:case e.SUB_WINDOW_STATUS.CANCEL:case e.SUB_WINDOW_STATUS.SUBMIT:return[3,16]}return[3,17];case 14:return[4,G(x,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f})];case 15:return i.sent(),[3,18];case 16:return s(S,I),[3,18];case 17:u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),i.label=18;case 18:return[3,20];case 19:u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),i.label=20;case 20:return[2]}}))}))}function K(){return new Promise((function(e){return setTimeout(e,1e3)}))}function j(e){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e.json()];case 1:return[2,t.sent()];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))}function G(r,n){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:return n.reconnectCount>=10?(n.onError(t.createLiffError(e.UNKNOWN,"Failed to connect")),[3,3]):[3,1];case 1:return[4,r(n)];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))}function q(e){var t={};return Object.keys(e).forEach((function(r){"closeButtonColor"===r?"white"===e[r]?t[r]="#ffffff":t[r]="#000000":t[r]=e[r]})),t}var V={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function J(r){var n=r.appData,i=r.native,o=u.getConfig().liffId,s=u.getMSTChallenge(),c=t.extractLiffId(r.url);if(!o)return Promise.reject(t.createLiffError(e.UNAUTHORIZED,"liffId is invalid"));if(!s)return Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst_challenge is invalid"));if(!c)return Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"params.url must be liff url"));var f=Object.assign({},V,i);return function(r){var n=r.mainLiffId,i=r.subLiffId,o=r.mstChallenge,s=r.appData,u=r.view;return n&&o?a.fetch(a.getEndPoint("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:n,subLiffId:i,mstChallenge:o,appData:s,view:u})}):Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))}({mainLiffId:o,subLiffId:c,mstChallenge:s,appData:n,view:q(f)}).then((function(t){var n=t.msit;x({msit:n,mstChallenge:s,onSuccess:function(e,t){S(e,t)},onError:function(t){S(e.SUB_WINDOW_STATUS.ERROR,t)}}),function(t,r){var n=t.url,i=new URLSearchParams;i.set("msit",r),location.href=e.SUB_WINDOW_MODAL_SCHEME_URL+"?url="+encodeURIComponent(n)+"&"+i.toString()}(r,n)}))}function F(){if(!f.isSubWindow())throw t.createLiffError(e.UNAUTHORIZED,"this api can be only called in child window")}function Z(r){if(!r.mst||!r.status)return Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"));var n=JSON.stringify(r);return a.fetch(a.getEndPoint("subWindowPost"),{method:"POST",body:n})}var k={on:function(e,t){_[e]||(_[e]=[]),_[e].push(t)},off:function(e,t){if(_[e]){var r=_[e].indexOf(t);r>=0&&_[e].splice(r,1)}},open:function(i){if(!n.isApiAvailable("subwindowOpen"))throw t.createLiffError(e.FORBIDDEN,"No permission for liff.subWindow.open()");if(!t.isLIFFBrowser()&&t.isLINEBrowser())throw t.createLiffError(e.FORBIDDEN,"Subwindow is not supported in this browser");return function(){if(f.isSubWindow())throw t.createLiffError(e.UNAUTHORIZED,"this api can be only called in parent window")}(),r.isInClient()?J(i):H(i)},cancel:function(n){return void 0===n&&(n={}),F(),r.isInClient()?function(r){return void 0===r&&(r={}),i.__awaiter(this,void 0,void 0,(function(){var n,o;return i.__generator(this,(function(i){switch(i.label){case 0:return(n=u.getMST())?[4,Z({mst:n,status:e.SUB_WINDOW_STATUS.CANCEL,result:r})]:[2,Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:return o=i.sent(),N(!0),[2,o]}}))}))}(n):function(t){return void 0===t&&(t={}),C(e.SUB_WINDOW_STATUS.CANCEL,t)}(n)},submit:function(n){return void 0===n&&(n={}),F(),r.isInClient()?function(r){return void 0===r&&(r={}),i.__awaiter(this,void 0,void 0,(function(){var n,o;return i.__generator(this,(function(i){switch(i.label){case 0:return(n=u.getMST())?[4,Z({mst:n,status:e.SUB_WINDOW_STATUS.SUBMIT,result:r})]:[2,Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:return o=i.sent(),N(!0),[2,o]}}))}))}(n):function(t){return void 0===t&&(t={}),C(e.SUB_WINDOW_STATUS.SUBMIT,t)}(n)},close:function(){return F(),r.isInClient()?function(){return i.__awaiter(this,void 0,void 0,(function(){var r;return i.__generator(this,(function(n){switch(n.label){case 0:return!1!==E()?[3,2]:(r=u.getMST())?[4,Z({mst:r,status:e.SUB_WINDOW_STATUS.CLOSE,result:{}})]:[2,Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:n.sent(),n.label=2;case 2:return l.closeWindow(),[2]}}))}))}():function(){return i.__awaiter(this,void 0,void 0,(function(){var t;return i.__generator(this,(function(r){return(null==(t=b())?void 0:t.isReady())?(t.send({eventName:e.SUB_WINDOW_STATUS.CLOSE}),[2,new Promise((function(t){setTimeout((function(){l.closeWindow(),t()}),e.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}))]):(l.closeWindow(),[2,Promise.resolve()])}))}))}()},getAppData:function(){return F(),function(){var e,t=u.getAppData();try{e=t?JSON.parse(t):{}}catch(r){e={}}return Promise.resolve(e)}()}};exports.getAppData=function(r){var n=r.mst;return n?a.fetch(a.getEndPoint("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:n})}):Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))},exports.getMSTByMSIT=function(r){var n=r.msit,i=r.mstVerifier;return n&&i?a.fetch(a.getEndPoint("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:n,mstVerifier:i})}):Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))},exports.getMainWindowOrigin=D,exports.getMessageBus=b,exports.initMessageBus=L,exports.setMainWindowOrigin=function(e){A.setItem("mainWindowOrigin",e)},exports.subWindow=k;
