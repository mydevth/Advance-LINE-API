"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/consts"),i=require("@liff/logger"),r=require("@liff/util"),s=require("@liff/store"),n=require("@liff/get-version"),o=require("@liff/is-logged-in"),u=require("@liff/get-profile");function a(){return e.__awaiter(this,void 0,void 0,(function(){var t,r;return e.__generator(this,(function(e){switch(e.label){case 0:if(!o.isLoggedIn())return[3,6];e.label=1;case 1:return e.trys.push([1,5,,6]),(t=s.getDecodedIDToken())&&t.sub?[2,t.sub]:[3,2];case 2:return[4,u.getProfile()];case 3:if((r=e.sent())&&r.userId)return[2,r.userId];e.label=4;case 4:return[3,6];case 5:return e.sent(),i.logger.debug("can't retrieve Mid/Uid because of something wrong"),[3,6];case 6:return[2]}}))}))}function f(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,a()];case 1:return(t=e.sent())&&"u"===t.substring(0,1)?[2,t]:[2]}}))}))}var c=function(){function u(){this.utsExtra={isLiffSuccessful:!1,isLoggedIn:!1,id:"",version:""},this.injected=!1}return Object.defineProperty(u,"CUSTOMPLACEID_INIT",{get:function(){return"liff.init"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"CUSTOMTYPE",{get:function(){return"liffSdk"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"GENERAL_UTS_ID",{get:function(){return"liff_general"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"GENERAL_APP_NAME",{get:function(){return"LIFF General"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"LiffUtsLoginStatus",{get:function(){return{isLoggedIn:1,isLiffSuccessful:2}},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"name",{get:function(){return"analytics"},enumerable:!1,configurable:!0}),u.prototype.install=function(e){var t=e.liff,i=e.internalHooks;this.liffCore=t,i.init.beforeFinished(this.beforeInitFinished.bind(this)),i.init.beforeSuccess(this.beforeInitSuccess.bind(this)),i.init.error(this.initError.bind(this))},u.prototype.changeRatioToUTSFormat=function(e){if(e&&Number.isFinite(e))return Math.round(100*e)},u.prototype.setExtra=function(){var e=this.utsExtra,t=e.isLiffSuccessful,i=e.isLoggedIn,r=e.id,s=e.version,n=(i?u.LiffUtsLoginStatus.isLoggedIn:0)|(t?u.LiffUtsLoginStatus.isLiffSuccessful:0);this.uts.setExtra("liff",{id:r,loginStatus:n,version:s})},u.prototype.assignUtsExtra=function(e){Object.assign(this.utsExtra,e)},u.prototype.setVersion=function(e){this.assignUtsExtra({version:e}),i.logger.debug("[LIFFUTS][SDK version] "+e),this.setExtra()},u.prototype.setLiffId=function(e){this.assignUtsExtra({id:e}),i.logger.debug("[LIFFUTS][LIFFID] "+e),this.setExtra()},u.prototype.setIsLoggedIn=function(e){this.assignUtsExtra({isLoggedIn:e}),i.logger.debug("[LIFFUTS][isLoggedIn] "+e),this.setExtra()},u.prototype.sendLiffInit=function(){i.logger.debug("[LIFFUTS][sendCustom] liff.init"),this.uts.sendCustom({type:u.CUSTOMTYPE,params:{placeId:u.CUSTOMPLACEID_INIT}})},u.prototype.setIsLiffSuccessful=function(e){this.assignUtsExtra({isLiffSuccessful:e}),i.logger.debug("[LIFFUTS][isLiffInitSuccessful] "+e),this.setExtra()},u.prototype.prepareReferrer=function(e){var i={};Object.keys(e).forEach((function(r){if(t.UTS_REFERRER_QUERY.includes(r)){var s=e[r];"string"==typeof s&&s&&(i[r.replace(/^liff\.ref\./,"")]=s)}})),Object.keys(i).length>0&&(this.referrer=i)},u.prototype.beforeInitFinished=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,a,c,l,g,d,p,h,b,I,L,E,S;return e.__generator(this,(function(v){switch(v.label){case 0:if(t=r.qs.parse(window.location.search),this.prepareReferrer(t),a=s.getContext(),!(c=null==a?void 0:a.utsTracking))return[2];if("auto"!==(l=c.mode)&&"force"!==l)return[3,6];i.logger.debug("[LIFFUTS] "+(new Date).toUTCString()),g=s.getConfig(),d=g.liffId,p=g.analytics,v.label=1;case 1:return v.trys.push([1,3,,4]),h=this,[4,new Promise((function(e,t){var i=window.uts,r=document.createElement("script");r.type="text/javascript",r.src="https://static.line-scdn.net/uts/edge/4.1.0/uts.js",r.onload=function(){var t=window.uts;e(t),window.uts=i},r.onerror=function(e){t(e)},document.getElementsByTagName("head")[0].appendChild(r)}))];case 2:return h.uts=v.sent(),[3,4];case 3:return b=v.sent(),i.logger.debug("[LIFFUTS] cannot load UTS, reason: "+b),[2];case 4:return I=void 0,L=void 0,"force"===l?(I={utsId:u.GENERAL_UTS_ID,appName:u.GENERAL_APP_NAME,appEnv:"release"},L={endpoint:"https://uts-front.line-apps.com",sampleRate:this.changeRatioToUTSFormat(c.sendRatio),version:"current"}):(I=e.__assign(e.__assign({},null==p?void 0:p.context),{utsId:(null==p?void 0:p.context.utsId)||u.GENERAL_UTS_ID,appName:(null==p?void 0:p.context.appName)||u.GENERAL_APP_NAME,appEnv:(null==p?void 0:p.context.appEnv)||"release"}),L=e.__assign(e.__assign({endpoint:"https://uts-front.line-apps.com"},null==p?void 0:p.options),{sampleRate:this.changeRatioToUTSFormat(c.sendRatio),version:"current"})),this.uts.init(I,L),[4,f()];case 5:(E=v.sent())&&(i.logger.debug("[LIFFUTS][mid] "+E),this.uts.setMid(E)),(null==a?void 0:a.tid)&&(i.logger.debug("[LIFFUTS][tid] "+a.tid),this.uts.setTid(a.tid)),this.referrer&&(i.logger.debug("liff.ref.referrer",this.referrer),this.uts.setSessionParams(this.referrer)),d&&this.setLiffId(d),this.setIsLoggedIn(o.isLoggedIn()),this.setVersion(n.getVersion()),S=r.removeCredential(location.href),i.logger.debug("[LIFFUTS][url] "+S),this.uts.setUrl(S),this.liffCore.analytics=this.uts,this.injected=!0,v.label=6;case 6:return[2]}}))}))},u.prototype.beforeInitSuccess=function(){return this.injected&&(this.setIsLiffSuccessful(!0),this.sendLiffInit()),Promise.resolve()},u.prototype.initError=function(){return this.injected&&(this.setIsLiffSuccessful(!1),this.sendLiffInit()),Promise.resolve()},u}();exports.AnalyticsModule=c,exports.sendShareTargetPicker=function(e){i.logger.debug("[LIFFUTS][sendCustom] liff.shareTargetPicker"),e.sendCustom({type:"liffSdk",params:{placeId:"liff.shareTargetPicker"}})};
