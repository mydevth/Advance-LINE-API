"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@liff/consts"),t=require("@liff/logger"),r=require("@liff/util"),i=require("@liff/store"),o=require("tslib");function a(t){return new CustomEvent(e.LIFF_EVENT,{detail:t})}!function(){if("function"!=typeof window.CustomEvent){function e(e,t){var r=t||{},i=r.bubbles,o=void 0!==i&&i,a=r.cancelable,n=void 0!==a&&a,l=r.detail,s=void 0===l?void 0:l,d=document.createEvent("CustomEvent");return d.initCustomEvent(e,o,n,s),d}e.prototype=Event.prototype,window.CustomEvent=e}}();var n={},l=!1;function s(t,r){l||(l=!0,window.addEventListener(e.LIFF_EVENT,(function(e){e&&e.detail&&e.detail.type&&n[e.detail.type]&&n[e.detail.type].forEach((function(t){return t(e)}))}))),n[t]?n[t].push(r):n[t]=[r]}function d(e,t){var r=n[e];if(r&&Array.isArray(r)){var i=r.indexOf(t);i>=0&&r.splice(i,1)}}function c(o,a,n){void 0===a&&(a={}),void 0===n&&(n="");var l=i.getFeatureToken();if(!l)throw r.createLiffError(e.FORBIDDEN,"Invalid featureToken for client features");if(!window._liff||!window._liff.postMessage)throw r.createLiffError(e.INVALID_ARGUMENT,"postMessage is not available from client");t.logger.debug("[js postMessage to client]",o,n,a),window._liff.postMessage(o,l,n,JSON.stringify(a))}exports.addListener=s,exports.call=function(a,n,l){return void 0===n&&(n={}),void 0===l&&(l={once:!0}),i.getFeatureToken()?(l=o.__assign({callbackId:r.randomAlphaNumericString(12),once:!0},l),new Promise((function(e,r){var i=function(o){if(o&&o.detail){var n=o.detail.callbackId===l.callbackId,s="string"!=typeof o.detail.callbackId;(n||s)&&(l.once&&d(a,i),t.logger.debug("[callback detail]",o.detail),o.detail.error?r(o.detail.error):o.detail.data?e(o.detail.data):r(o.detail))}r()};s(a,i),c(a,n,l.callbackId)}))):Promise.reject(r.createLiffError(e.FORBIDDEN,"Invalid featureToken for client features"))},exports.createEvent=a,exports.dispatch=function(i){var o={};try{o=JSON.parse(i)}catch(l){throw r.createLiffError(e.INVALID_ARGUMENT,l.message)}var n=a(o);t.logger.debug("[client dispatchEvent to js]",{type:n.type,detail:n.detail}),window.dispatchEvent(n)},exports.postMessage=c,exports.removeListener=d;
