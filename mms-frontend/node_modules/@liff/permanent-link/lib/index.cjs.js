"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),r=require("@liff/consts"),t=require("@liff/util"),n=require("@liff/store"),i=require("@liff/server-api");function a(n){return e.__awaiter(this,void 0,void 0,(function(){var a,o;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,fetch(i.getEndPoint("permanentLink"),{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"POST",body:JSON.stringify(n)})];case 1:return(a=e.sent()).ok?[3,3]:[4,a.json()];case 2:throw o=e.sent().message,t.createLiffError(r.UNKNOWN,o);case 3:return[4,a.json()];case 4:return[2,e.sent()]}}))}))}var o=function(){function i(){var i=this;this.extraParams="",this.getAndValidateContext=function(){var e=n.getContext();if(!e)throw t.createLiffError(r.INIT_FAILED,"Could not get Context from server.");if(!e.endpointUrl)throw t.createLiffError(r.INIT_FAILED,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw t.createLiffError(r.INIT_FAILED,"Could not get permanentLinkPattern from server.");return e},this.createUrl=function(){var e=i.getAndValidateContext(),a=window.location,o=a.pathname,s=a.search,f=a.hash,u=a.origin,c=new URL(e.endpointUrl);if(c.origin!==u||!i.isAncestor(c.pathname,o))throw t.createLiffError(r.INVALID_CONFIG,"Current page is not under entrypoint.");var l=o.substring(c.pathname.length);l.length>0&&"/"!==l[0]&&(l="/"+l);var h=new RegExp("^"+r.CREDENTIAL_KEYS.join("|")),g=f.substring(1).split("&").filter((function(e){return!h.test(e)&&Boolean(e)})).join("&"),d=g===c.hash.substring(1)?"":g,p=function(e){return e.substring(1).split("&").filter((function(e){return!/liff\.state/.test(e)&&Boolean(e)}))},m=p(s),I=p(c.search);i.extraParams&&m.push(i.extraParams);for(var L=0;L<I.length;L++){var v=I[L],E=m.indexOf(v);E>-1&&m.splice(E,1)}var _=m.join("&"),w=l+(""!==_?"?"+_:"")+(d?"#"+d:"");return""+r.PERMANENT_LINK_ORIGIN+n.getConfig().liffId+w},this.createUrlBy=function(o){return e.__awaiter(i,void 0,void 0,(function(){var i,s;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(i=n.getConfig().liffId))throw t.createLiffError(r.INIT_FAILED,"Should run after liff init.");try{s=new URL(o)}catch(f){throw t.createLiffError(r.INVALID_ARGUMENT,"invalid URL.")}return[4,a({liffId:i,currentPageUrl:s.toString()})];case 1:return[2,e.sent().permanentLinkUrl]}}))}))},this.setExtraQueryParam=function(e){i.extraParams=e},this.isAncestor=function(e,r){return 0===r.indexOf(e)&&(e.endsWith("/")&&(e=e.substring(0,e.length-1)),void 0===r[e.length]||"/"===r[e.length])},this.install=function(){return{createUrl:i.createUrl,createUrlBy:i.createUrlBy,setExtraQueryParam:i.setExtraQueryParam}}}return Object.defineProperty(i.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),i}(),s=new o;exports.PermanentLink=o,exports.module=s;
